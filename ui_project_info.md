# UI自动化测试模块 - 项目需求文档

> 创建日期：2026-01-20
> 状态：**端到端测试完成，核心问题已修复**
> 版本：v0.10.0-beta
> 最后更新：2026-01-22

---

## 一、项目概述

### 1.1 项目定位

基于 **browser_use** 开源框架的 AI 驱动 UI 自动化测试平台。用户通过自然语言描述测试场景，AI 自动理解并执行浏览器操作，生成可视化测试报告。

### 1.2 核心价值

- **自然语言驱动**：无需编码，用中文描述测试意图即可
- **AI 智能执行**：browser_use Agent 自动解析并操作浏览器
- **CLI 独立执行**：支持命令行直接调用，便于调试和 CI/CD 集成
- **API 集成调用**：后端通过 subprocess 调用 CLI，实现前端触发的测试执行
- **混合模式架构**：CLI 和 API 两种调用方式同等重要
- **完全模块化**：独立于 API 自动化模块，可独立部署
- **可视化报告**：实时展示执行过程和结果
- **统一界面风格**：与 API 自动化模块保持一致的用户体验

### 1.3 技术选型

| 分类 | 技术栈 | 说明 |
|------|--------|------|
| **执行引擎** | browser_use (Python) | GitHub: https://github.com/browser-use/browser-use |
| **LLM 模型** | OpenAI GPT-4o-mini / ChatBrowserUse | 支持自定义 API 端点 |
| **浏览器** | Chromium (Playwright驱动) | 支持无头/有头模式 |
| **后端框架** | Django + DRF | 与现有项目保持一致 |
| **前端框架** | Vue 3 + TypeScript + Element Plus | 沿用现有设计系统 |
| **数据库** | SQLite (开发) / MySQL (生产) | 表前缀：`ui_` |
| **Python 环境** | Python 3.12 | 路径：`D:\Python3.12\python.exe` |

---

## 二、架构设计

### 2.1 整体架构图（混合模式）

```
┌─────────────────────────────────────────────────────────────────┐
│                         前端层 (Vue 3)                            │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  左侧Logo下拉切换：[API测试 ▼] [AI驱动UI测试 ▼]             │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                  │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │  自然语言编辑器   │  │  执行监控面板    │  │  测试报告查看    │  │
│  │  (Markdown输入) │  │  (实时日志/截图) │  │  (JSON报告解析) │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                                │
                                │ HTTP/REST API + WebSocket
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                       后端层 (Django)                            │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │              ui_automation 模块 (完全独立)                  │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │  │
│  │  │  测试用例管理  │  │CLI执行服务  │  │  报告管理服务 │        │  │
│  │  │  (CRUD API)  │  │(subprocess) │  │  (JSON报告)  │        │  │
│  │  └─────────────┘  └─────────────┘  └─────────────┘        │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                  │                            │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │              CliTestExecutorService                          │  │
│  │  - 构建 subprocess 命令                                        │  │
│  │  - 实时解析 stdout/stderr (##PROGRESS##, ##RESULT##)         │  │
│  │  - 推送 WebSocket 进度消息                                    │  │
│  │  - 更新执行记录和报告                                        │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                                │
                                │ subprocess.Popen()
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│              run_aiTest.py (CLI 执行脚本)                         │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  1. 解析 CLI 参数 (--task, --browser-mode, --model, 等)     │  │
│  │  2. 从 .env 加载 OPENAI_API_KEY 和 OPENAI_API_BASE_URL      │  │
│  │  3. 初始化 browser-use Agent                                │  │
│  │  4. 执行测试任务                                            │  │
│  │  5. 输出进度: ##PROGRESS##{json}                              │  │
│  │  6. 保存测试报告到 report/ 目录                               │  │
│  │  7. 输出结果: ##RESULT##{json}                               │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    browser_use 执行层                            │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  Agent(task=task, llm=llm)                                 │  │
│  │    ├── 执行浏览器操作                                      │  │
│  │    ├── 生成执行历史                                        │  │
│  │    └── 保存报告到 report/ 目录                              │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 文件结构

```
Django_project/ui_automation/
├── browser-use-0.11.2/              # browser_use 源码
│   ├── .env                         # LLM API 配置
│   ├── run/                         # CLI 执行脚本目录
│   │   └── run_aiTest.py           # 通用执行脚本
│   ├── report/                      # 测试报告目录
│   │   └── exec_*.json             # JSON 格式报告
│   └── browser_use/                 # 核心代码
│
├── services/                         # 业务服务
│   ├── cli_test_executor_service.py # CLI 调用服务
│   ├── websocket_service.py         # WebSocket 推送服务
│   └── ...
│
├── models.py                         # 数据模型
├── serializers.py                    # 序列化器
├── views.py                          # API 视图
└── urls.py                           # 路由配置

VUE3/src/modules/ui-automation/
├── views/                            # 页面视图
│   ├── Project/                      # 项目管理
│   ├── TestCase/                     # 用例管理
│   ├── Execution/                    # 执行记录
│   └── Report/                       # 报告展示
├── stores/                           # Pinia 状态管理
├── api/                              # API 调用
└── types/                            # TypeScript 类型定义
```

---

## 三、功能清单

| 模块 | 功能 | 状态 |
|------|------|------|
| **项目管理** | 项目 CRUD | ✅ 完成 |
| **用例管理** | 自然语言编辑器、CRUD、复制 | ✅ 完成 |
| **执行记录** | 列表、筛选、详情、取消 | ✅ 完成 |
| **执行监控** | 实时日志推送 | ✅ 完成 |
| **报告查看** | JSON 报告解析、详情展示 | ✅ 完成 |
| **报告导出** | JSON 格式导出 | ✅ 完成 |
| **CLI 执行** | 独立脚本调用 | ✅ 完成 |
| **WebSocket** | 实时状态更新、错误通知 | ✅ 优化完成 |

---

## 四、开发进度

### 4.1 里程碑

| 里程碑 | 状态 | 完成时间 | 说明 |
|--------|------|----------|------|
| M0-M5 | ✅ 已完成 | 2026-01-21 | 基础框架和前端开发 |
| M6 | ✅ 已完成 | 2026-01-22 | 通用执行脚本（CLI + API） |
| M7 | ✅ 已完成 | 2026-01-22 | 报告展示功能（JSON 解析） |
| M8 | ✅ 已完成 | 2026-01-22 | 执行记录与报告关联优化 |
| M9 | ✅ 已完成 | 2026-01-22 | P1 短期优化功能 |
| M10 | ✅ 已完成 | 2026-01-22 | 端到端测试与问题修复 |

### 4.2 M10 里程碑：端到端测试与问题修复

**完成时间**：2026-01-22

**解决的问题**：

1. **报告文件路径问题**
   - 问题：报告路径存储为相对路径，导致文件无法找到
   - 解决：转换为绝对路径存储，确保文件可访问
   - 修改：`views.py` 中路径转换逻辑

2. **WebSocket 实时更新优化**
   - 增强 `broadcast_status_change()` 支持额外数据
   - 新增 `broadcast_error()` 专门广播错误信息
   - 执行关键节点广播状态变更（开始、完成、报告生成）

3. **错误处理机制完善**
   - 详细的状态判断（passed/failed/error）
   - 错误时记录完整堆栈信息
   - 通过 WebSocket 实时通知错误
   - 改进报告文件端点错误消息

**修改文件**：
- `ui_automation/services/websocket_service.py`
- `ui_automation/views.py`

---

## 五、CLI 执行脚本使用指南

### 5.1 独立 CLI 调用

**基础用法**：
```bash
cd D:\AI\AI-test-project\Django_project\ui_automation\browser-use-0.11.2\run
D:\Python3.12\python.exe run_aiTest.py --task "打开百度首页"
```

**完整参数**：
| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `--task` | string | 必填 | 自然语言测试任务 |
| `--browser-mode` | headless/headed | headless | 浏览器模式 |
| `--model` | string | gpt-4o-mini | LLM 模型 |
| `--max-steps` | int | 50 | 最大步骤数 |

### 5.2 输出格式

**进度输出**：
```
##PROGRESS##{"timestamp": "...", "level": "info", "message": "开始执行任务"}
```

**结果输出**：
```
##RESULT##{"success": true, "report_path": "...", "total_steps": 5}
```

---

## 六、技术环境配置

### 6.1 .env 配置

```env
OPENAI_API_KEY=你的API密钥
OPENAI_API_BASE_URL=https://aihubmix.com/v1
```

### 6.2 Python 环境

- Python 3.12
- 路径：`D:\Python3.12\python.exe`

---

## 七、已知问题

### 7.1 已解决

| 问题 | 解决方案 | 状态 |
|------|----------|------|
| 报告路径为相对路径 | 转换为绝对路径存储 | ✅ 已修复 |
| WebSocket 错误通知缺失 | 新增 broadcast_error 方法 | ✅ 已修复 |
| 错误处理不够详细 | 完善异常捕获和堆栈记录 | ✅ 已修复 |

### 7.2 可忽略问题

| 问题 | 影响 |
|------|------|
| Windows 日志编码（GBK无法显示emoji） | 不影响功能 |

---

## 八、下一步开发计划

### 8.1 短期计划（P1 - 建议）

| 功能 | 优先级 | 说明 |
|------|--------|------|
| **真实测试执行验证** | P0 | 运行完整测试用例验证端到端流程 |
| **前端集成测试** | P0 | 手动测试所有新增功能 |
| **报告美化展示** | P1 | HTML 格式展示、样式优化 |

### 8.2 中期计划（P2）

| 功能 | 优先级 | 说明 |
|------|--------|------|
| **批量执行** | P2 | 选择多个用例批量执行 |
| **执行历史对比** | P2 | 同一用例多次执行结果对比 |
| **定时任务** | P2 | 定时自动执行测试 |
| **数据看板** | P1 | 统计图表、测试趋势展示 |

### 8.3 测试建议

1. **创建多样化测试用例**
   - 简单导航任务
   - 表单填写任务
   - 搜索和内容提取任务

2. **验证完整流程**
   - 测试创建 → 执行 → 监控 → 报告查看 → 报告导出

3. **性能测试**
   - 无头 vs 有头模式性能对比
   - 长时间任务稳定性测试

---

*文档维护：本文档记录项目开发进度和架构信息，持续更新*
